<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Caption Demo (Simple)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; padding: 24px; background:#fafafa; }
    .card { background:#fff; padding:16px; border:1px solid #eee; border-radius:12px; max-width:720px; margin:auto; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 16px; border-radius:8px; border:1px solid #ddd; background:#f5f5f5; cursor:pointer; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    video { width:100%; max-height:60vh; background:#000; border-radius:12px; margin-top:12px; }
    .log { font-size:14px; color:#444; white-space:pre-wrap; margin-top:8px; }
    .hint { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <div class="card">
    <h1>🎬 تجربة بسيطة جدًا: رفع فيديو + كابتشن VTT</h1>
    <div class="row">
      <input id="file" type="file" accept="video/*" />
      <button id="btn">رفع وتحويل</button>
      <span class="hint">أرفع فيديو قصير للاختبار.</span>
    </div>

    <video id="player" controls></video>

    <div class="log" id="log"></div>
  </div>

  <script>
    const fileInput = document.getElementById('file');
    const btn = document.getElementById('btn');
    const log = document.getElementById('log');
    const player = document.getElementById('player');
    let currentTrack = null;

    function write(msg){ log.textContent = msg; }

    btn.addEventListener('click', async () => {
      const file = fileInput.files?.[0];
      if (!file) { write('من فضلك اختر ملف فيديو.'); return; }

      // عرض الفيديو محليًا فورًا
      const localUrl = URL.createObjectURL(file);
      player.src = localUrl;

      // إزالة track قديم
      if (currentTrack) {
        player.removeChild(currentTrack);
        currentTrack = null;
      }

      btn.disabled = true;
      write('جاري الرفع والمعالجة...');

      try {
        const fd = new FormData();
        fd.append('video', file);

        const resp = await fetch('/api/transcribe', { method: 'POST', body: fd });
        const data = await resp.json();

        if (!resp.ok) {
          write(`حدث خطأ: ${data.error || 'unknown'}\n${data.details ? JSON.stringify(data.details, null, 2) : ''}`);
          btn.disabled = false;
          return;
        }

        // استلام نص VTT من الخادم
        const vttText = data.vtt || '';
        if (!vttText.trim()) {
          write('لم يتم استلام VTT.');
          btn.disabled = false;
          return;
        }

        // إنشاء Blob VTT وربطه كـ track
        const vttBlob = new Blob([vttText], { type: 'text/vtt' });
        const vttUrl = URL.createObjectURL(vttBlob);

        const track = document.createElement('track');
        track.kind = 'subtitles';
        track.label = 'Arabic';
        track.srclang = 'ar';
        track.default = true;
        track.src = vttUrl;

        player.appendChild(track);
        currentTrack = track;

        write('تم! شغّل الفيديو وستظهر الترجمة (قد تحتاج تفعيلها من إعدادات المشغل).');
      } catch (e) {
        write('فشل الطلب: ' + e.message);
      } finally {
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>